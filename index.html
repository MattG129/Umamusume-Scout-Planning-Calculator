<!-- TODO: Add comments. -->
<!DOCTYPE html>

<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Umamusume Scout Planning Calculator</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="description" content="" />
        
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="BoilerPlate.js" type="text/javascript"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
        <script src="BannersInfo.js" type="text/javascript"></script>
        <script src="ScoutCalcs.mjs" type="text/javascript"></script>

        <script src="https://parsleyjs.org/dist/parsley.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.0/jquery-ui.min.js"></script>
        <script src="assets\js\jquery-ui-touch-punch\jquery.ui.touch-punch.js"></script> <!-- Helps the dragables work on mobile. -->

        <script type="text/javascript">
            let Page = 'index';

            let NewScoutPlanRowID; // Initializing here so it can be used throughout the whole code and kept consistent.
        </script>
    </head>
    <body>
        <style>
            body, html {
                margin-bottom: 2.5%;
                margin-top: 2.5%;
            }

            body { 
                color: black;
                background-color: #9990a3;
            }

            #LoadingSpinner {
                width: 50px;
                height: 50px;
                border: 3px solid rgba(255,255,255,.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
                -webkit-animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }
            @-webkit-keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }

            ul.parsley-errors-list {
                list-style-type: none;
                padding: 0;
                margin: 0;
                color: #800000;
            }

            i.bi-question-circle {
                color: white;
            }

            .TableField {
                border-color: black;
                font-size: min(3vw, 16px);
            }

            /* td-label is used by table cells and labels when we want an entire table cell to act as a label for a checkbox it contains. */
            td.td-label {
                position: relative;
            }

            td.td-label:hover {
                background-color: #E1EDF0;
            }

            label.td-label {
                position: absolute;
                top: 0%;
                left: 0;
                width: 100%;
                height: 100%;
            }

            .swal-button {
                background-color: #4962B3;
            }

            .swal-button:not([disabled]):hover {
                background-color: #5B71BA;
            }

            .btn-add {
                background: #52B4FA;
            }

            .btn-add:not([disabled]):hover {
                background: #90D5FF;
            }

            #ScoutPlanningResultsTable {
                width: 75%;
            }

            @media only screen and (max-width: 600px) {
                #ScoutPlanningResultsTable {
                    width: 100%;
                }
            }
            
            .InactiveScoutPlanRow {
                color: gray;
                border-color: gray;
            }
        </style>

        <div id='Header'></div>

        <form id="form" data-parsley-validate="true">
            <div class="container">
                <hr><center><h2>Calculator Settings</h2></center><br>

                <div class="accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="ImportExportAccordion">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ImportExportAccordionContent" aria-expanded="false" aria-controls="ImportExportAccordionContent">
                                <h4 class="d-block w-100 text-center">Import/Export</h4>
                            </button>
                        </h2>
                        <div id="ImportExportAccordionContent" class="accordion-collapse collapse" aria-labelledby="ImportExportAccordion" data-bs-parent="#ImportExportAccordion">
                            <div class="accordion-body">
                                <label for="ImportState" class="form-label">
                                    You can click the <b>Export</b> button below to copy all your scout planning info for future use. When you are ready to use the calculator again, you can paste that info into the text box below and click <b>Import</b> or <b>Import and Run</b>.
                                </label><br>
                                <center>
                                    <textarea id="ImportState" class="form-control" style="border-color: black;" rows="5"></textarea><br>
                                    <p id="InvalidImportMessage" style="color: red; display: none;">Invalid Import.</p>
                                    
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Import(RunCalcs=false, ImportState=$('#ImportState').val(), Scroll=true);">
                                        Import
                                    </a>
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Export();">
                                        Export
                                    </a>
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Import(RunCalcs=true, ImportState=$('#ImportState').val(), Scroll=true);">
                                        Import and Run
                                    </a>
                                    <br>
                                </center>
                            </div>
                        </div>
                    </div>
                </div>
                <br>

                <center>
                    <div class="form-check form-check-inline form-switch">
                        <input type="checkbox" id="DisableUnsavedChangesWarning" class="form-check-input">
                        <label for="DisableUnsavedChangesWarning" class="form-label">Disable unsaved changes warning</label>
                    </div>

                    <a id="CalculatorHeaderAnchor"></a>

                    <hr><h2>Currency</h2><br>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="FC" class="form-label">Free Carrots</label>
                            <input type="number" id="FC" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="PC" class="form-label">Paid Carrots</label>
                            <input type="number" id="PC" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="UmaTicket" class="form-label">Trainee Scout Ticket</label>
                            <input type="number" id="UmaTickets" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="CardTicket" class="form-label">Support Card Scout Ticket</label>
                            <input type="number" id="CardTickets" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>
                    </div>
                    <br>

                    <hr><h2>Scout Planning</h2><br>

                    <!-- TODO: Using this as a basis for the banner dropdown to be copied off of -->
                    <select id="BannerEnd" class="form-select" style="max-width: 300px; display: none;"></select>
                    <script type="text/javascript">
                        $(function() {
                            for (let i = 0; i < BannersInfo.length; i++) {
                                if (BannersInfo[i].GlobalEndDate >= Today && BannersInfo[i].Disabled != true) {
                                    $('#BannerEnd').append($('<option>', {
                                        value: i,
                                        text: `${BannersInfo[i].Name}: ${moment(BannersInfo[i].GlobalStartDate, "YYYY-MM-DD").format('L')} - ${moment(BannersInfo[i].GlobalEndDate, "YYYY-MM-DD").format('L')}`,
                                    }));
                                }
                            };
                        });
                    </script>

                    <div style="overflow-x: auto;">
                        <table id="ScoutPlanningTable" class="table table-bordered table-striped" style="font-size: min(3vw, 16px); text-align: center; border: 1px;">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">
                                        <!-- Veritcal Grip -->
                                    </th>
                                    <th style="width: 40%; min-width: 125px;">
                                        Banner
                                        <a data-toggle="tooltip"
                                            title="Dates are in American server time. The calculator currently assumes that banners end at 12:00 AM (0:00) on the banner end date."
                                        >
                                            <i class="bi bi-question-circle" style="color: black;"></i>
                                        </a>
                                    </th>
                                    <th style="width: 15%; min-width: 80px;">
                                        Exchange Points
                                    </th>
                                    <th style="width: 15%; min-width: 80px;">
                                        Copies
                                    </th>
                                    <th style="width: 10%;">
                                        Active
                                    </th>
                                    <th style="width: 10%;">
                                        <!-- Remove Button -->
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="ScoutPlanningTableBody">
                                <!--- Rows will be added by the script below. --->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="7">
                                        <button id="AddRowButton" type="button" style="width: 100%" class="btn btn-add">
                                            <b><i class="bi bi-plus-lg" style="font-size: 30px; font-weight: bold; color: white;"></i></b>
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <script type="text/javascript">
                        function AddScoutPlanRow() {
                            let NewRow = $(
                                `<tr id="ScoutPlanRow${NewScoutPlanRowID}" data-scoutplan-rowid="${NewScoutPlanRowID}">`+
                                    `<td class="handle" style="vertical-align: middle;"><i class="bi bi-arrows-move" style="font-size: 20px"></i></td>`+
                                    `<td>`+
                                        `<center>`+
                                            `<select class="ScoutPlanBanner form-select"></select>`+
                                        `</center>`+
                                    `</td>`+
                                    `<td>`+
                                        `<center>`+
                                            `<input type="number" class="ScoutPlanExchangePoints form-control" data-parsley-trigger="input" data-parsley-required="true" Value="0" min="0" max="199" data-parsley-range="[0,199]">`+
                                        `</center>`+
                                    `</td>`+
                                    `<td>`+
                                        `<center>`+
                                            `<input type="number" class="ScoutPlanGoal form-control" data-parsley-trigger="input" data-parsley-required="true" Value="1" data-parsley-min="1" min="1">`+
                                        `</center>`+
                                    `</td>`+
                                    `<td class="td-label">`+
                                        `<label class="td-label">`+
                                            `<input type="checkbox" class="ScoutPlanActive form-check-input align-middle" onchange="ToggleScoutPlanRow(this, ${NewScoutPlanRowID}); UpdateCalculateButton();" checked>`+
                                        `</label>`+
                                    `</td>`+
                                    `<td>`+
                                        `<button type="button" class="btn btn-danger" onclick="$('#ScoutPlanRow${NewScoutPlanRowID}').remove(); UpdateCalculateButton();">`+
                                            `<i class="bi bi-x-lg" style=" font-weight: bold;"></i>`+
                                        `</button>`+
                                    `</td>`+
                                `</tr>`
                            );

                            $('#ScoutPlanningTableBody').append(NewRow);
                            $('#ScoutPlanningTableBody').sortable("refresh");

                            $(`tr[data-scoutplan-rowid=${NewScoutPlanRowID}] .ScoutPlanBanner`).html($('#BannerEnd').html());
                            $(`tr[data-scoutplan-rowid=${NewScoutPlanRowID}] input, tr[data-scoutplan-rowid=${NewScoutPlanRowID}] select`).addClass('ScoutPlanField TableField');

                            SetParsleyValidations();

                            NewScoutPlanRowID++;
                        };

                        $(function() {
                            NewScoutPlanRowID = 0;

                            $('#ScoutPlanningTableBody').sortable({handle: ".handle"});

                            $("#AddRowButton").click(function() {AddScoutPlanRow(); UpdateCalculateButton();});

                            // We want the table to load with 3 rows by default.
                            for (let i = 0; i < 3; i++) AddScoutPlanRow();
                        });
                    </script>

                    <hr><h2>PVP</h2><br>
                    <div class="row">
                        <div class="col-md-6">
                            <h3>Champions Meeting</h3><br>

                            <select id="CMLeague" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                <option value="1">Open League</option>
                                <option value="2">Graded League</option>
                            </select>

                            <div class="row">
                                <div class="col-md-4">
                                    <h4>Round 1</h4>
                                    
                                    <label for="CMR1Sets" class="form-label">Number of Sets</label>
                                    <input type="number" id="CMR1Sets" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,8]" min="0" max="8" Value="0">
                                    
                                    <label for="CMR1WR" class="form-label">Win Rate (%)</label>
                                    <input type="number" id="CMR1WR" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,100]" min="0" max="100" Value="0">
                                </div>

                                    
                                <div class="col-md-4">
                                    <h4>Round 2</h4>

                                    <label for="CMR2Group" class="form-label">Group</label>
                                    <select id="CMR2Group" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                        <option value="1">A</option>
                                        <option value="2">B</option>
                                    </select>
                                    
                                    <label for="CMR2Sets" class="form-label">Number of Sets</label>
                                    <input type="number" id="CMR2Sets" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,8]" min="0" max="8" Value="0">

                                    <label for="CMR2WR" class="form-label">Win Rate (%)</label>
                                    <input type="number" id="CMR2WR" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,100]" min="0" max="100" Value="0">
                                </div>

                                <div class="col-md-4">
                                    <h4>Round 3</h4>
                                   
                                    <label for="CMR3Group" class="form-label">Group</label>
                                    <select id="CMR3Group" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                        <option value="1">A</option>
                                        <option value="2">B</option>
                                    </select>

                                    <label for="CMR3Placement" class="form-label">Placement</label>
                                    <input type="number" id="CMR3Placement" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[1,3]" min="1" max="3" Value="3">
                                </div>
                            </div>

                        </div>
                        <div class="col-md-3">
                            <h3>Team Trials</h3>
                            <label for="TeamTrialsClass" class="form-label">Team Trials Class</label>
                            <input type="number" id="TeamTrialsClass" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[1,6]" min="1" max="6" Value="1">
                        </div>

                        <div class="col-md-3">
                            <h3>Club Rewards</h3>
                            <label for="ExpectedClubRank" class="form-label">Expected Club Ranking</label>
                            <a data-toggle="tooltip" 
                                title="The grade rankings may not be entirely accurate."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                            <select id="ExpectedClubRank" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                <option value="1">SS (1-10)</option>
                                <option value="2">S+ (11-30)</option>
                                <option value="3">S &nbsp;&nbsp;(31-100)</option>
                                <option value="4">A+ (101-500)</option>
                                <option value="5">A &nbsp;&nbsp;(501-100)</option>
                                <option value="6">B+ (1001-3000)</option>
                                <option value="7">B &nbsp;&nbsp;(3001-5000)</option>
                                <option value="8">C+ (5001-7000)</option>
                                <option value="9">C &nbsp;&nbsp;(7001-10000)</option>
                                <option value="10">D+ (10001-30000)</option>
                                <option value="11">D &nbsp;&nbsp;(> 30000)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <hr>
                        <h2>
                            Daily Carrot Pack
                            <a data-toggle="tooltip"
                                title="This calculator will assume that the <b>Daily Carrot Pack</b> will either be purchased from now until continuously or not at all."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                        </h2>
                        <br>

                        <div class="form-check form-check-inline">
                            <input type="checkbox" id="HasDailyCarrotPack" class="form-check-input">
                            <label for="HasDailyCarrotPack" class="form-label">Purchasing Daily Carrot Pack</label>
                        </div>
                    </div>

                    <hr><h2>Scout Results</h2><br>

                    <a id="Calculate" class="btn btn-primary" style="border-width: 1px; border-color: black;">Calculate</a>
                </center>
            </div>
            <br>
        </form>

        <div class="container">
            <center>
                <div id="LoadingGroup" style="display: none;">
                    <div id="LoadingSpinner"></div>
                    <br>
                    Loading...
                </div>

                <a id="ScoutResultsAnchor"></a>

                <div id="ScoutPlanOrderError" class="ScoutResults" style="display: none; color: #800000;"></div>

                <table id="ScoutPlanningResultsTable" class="table table-bordered table-striped ScoutResults" style="font-size: min(3vw, 16px); text-align: center; border: 1px; display: none;">
                    <thead>
                        <tr>
                            <th style="width: 40%">Banner</th>
                            <th style="width: 20%">Copies</th>
                            <th style="width: 20%">Max Scouts</th>
                            <th style="width: 20%">Chance of Success</th>
                        </tr>
                    </thead>
                    <tbody id="ScoutPlanningResultsBody"> <!--- Will be filled in by ScoutPlanningCalculator. ---> </tbody>
                    <tfoot> <!--- Will be filled in by ScoutPlanningCalculator. ---> </tfoot>
                </table>

                <hr>
                <div id="Footer"></div>
            </center>
        </div>

        <script type="text/javascript">
            // When leaving the page, we will save the users form inputs to local storage so that we can import them again after the page has been refreshed. This is needed to reconstruct the scout planning table.
            $(document).on('visibilitychange', function() {
                localStorage.setItem("SessionState", JSON.stringify(CompileForm()));
            });

            $(function() {
                let SessionState = localStorage.getItem("SessionState");

                if (SessionState != null) {
                    // TODO: Add a toggle to turn this off.
                    Import(RunCalcs=false, ImportState=SessionState, Scroll=false);
                };
            });

            function getInvalidFields() {
                let InvalidFields = [];
                
                $('input:not([type="checkbox"])').each(function() {
                    if (!$(this).parsley().isValid() && $(this).is(":visible")) {
                        InvalidFields.push($(this).attr('id'));
                    };
                });

                return InvalidFields;
            };

            let ResultsLoaded = false;
            function UpdateCalculateButton() {
                let CalculateText = ResultsLoaded ? 'Recalculate' : 'Calculate'

                if ( $('tr[data-scoutplan-rowid]:not(.InactiveScoutPlanRow)').length > 0 ) {
                    $("#Calculate").html(CalculateText);
                    $("#Calculate").removeClass('disabled');
                }
                else {
                    $("#Calculate").html(CalculateText + "<br><span style='font-size: small;'>(Must add scout goals.)</span>");
                    $("#Calculate").addClass('disabled');
                };
            };

            UpdateCalculateButton();

            $("#Calculate").on('click', function() {
                $('.ScoutResults').hide();

                let InvalidFields = getInvalidFields();
                if (InvalidFields.length > 0) {
                    swal({icon: 'error', text: 'Please correct invalid data before running calculations.'});

                    $('html, body').animate({scrollTop: $(`#${InvalidFields[0]}`).offset().top-100, easing: 'linear'}, 250);
                }
                else {
                    setTimeout(function () {$("#Calculate").hide()}, 0);

                    $('#LoadingGroup').show();

                    $('html, body').animate({scrollTop: $("#LoadingGroup").offset().top, easing: 'linear'}, 100);

                    setTimeout(function () {
                        if (ScoutPlanningCalculator(CompileForm()).Success) {
                            ResultsLoaded = true;
                            UpdateCalculateButton();
                        };

                        $('#LoadingGroup').hide();

                        $('html, body').animate({scrollTop: $("#ScoutResultsAnchor").offset().top, easing: 'linear'}, 250);
                        
                        $("#Calculate").show();
                    }, 500);
                };
            });

            function ToggleScoutPlanRow(caller, ScoutPlanRowID) {
                if ($(caller).is(':checked')) {
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}], tr[data-scoutplan-rowid=${ScoutPlanRowID}] input, tr[data-scoutplan-rowid=${ScoutPlanRowID}] select`).removeClass('InactiveScoutPlanRow');
                }
                else {
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}], tr[data-scoutplan-rowid=${ScoutPlanRowID}] input, tr[data-scoutplan-rowid=${ScoutPlanRowID}] select`).addClass('InactiveScoutPlanRow');
                };
            };

            function CompileForm(){
                let FormValues = {};

                $('#form input:not(.ScoutPlanField), #form select:not(.ScoutPlanField)').each(function() {
                    if ($(this).is(':checkbox')) {
                        FormValues[this.id] = $(this).is(':checked');
                    }
                    else {
                        FormValues[this.id] = this.value == '' ? '' : Number(this.value);
                    };
                });

                FormValues.ScoutPlanArray = [];
                $('tr[data-scoutplan-rowid]').each(function() {
                    FormValues.ScoutPlanArray.push({
                        Banner:            Number($(this).find('td .ScoutPlanBanner').val()),
                        ExchangePoints:    Number($(this).find('td .ScoutPlanExchangePoints').val()),
                        Goal:              Number($(this).find('td .ScoutPlanGoal').val()),
                        Active:                   $(this).find('td .ScoutPlanActive').is(':checked')
                    });
                });

                return FormValues
            };

            function Import(RunCalcs, ImportState, Scroll) {
                let isValidImport = true;
                let JSONImport;

                try {
                    JSONImport = JSON.parse(ImportState);

                    // Since some of the import code explicitly references the scout plan mapper it needs to be defined.
                    if (JSONImport.ScoutPlanArray == undefined) {
                        isValidImport = false;
                    };
                } catch (error) {
                    isValidImport = false;
                };

                if (!isValidImport) {
                    $('#InvalidImportMessage').show();
                }
                else {
                    $('#InvalidImportMessage').hide();

                    $('#form input:not(.ScoutPlanField), #form select:not(.ScoutPlanField)').each(function() {
                        if ($(this).is(':checkbox')) {
                            $(this).prop('checked', JSONImport[this.id]);
                        }
                        else {
                            $(this).val(JSONImport[this.id]);
                        };
                    });

                    // We will remove the existing scout planning rows to avoid any potential conflicts with the imported ones.
                    $('tr[data-scoutplan-rowid]').remove();
                    NewScoutPlanRowID = 0;

                    // TODO: Test this with an expired banner. Also, test what happens if an invalid banner val is used.
                    let AnnounceExpiredItems = false; // We will only set this to true when there are active expired scout plan rows.
                    for (let i = 0; i < JSONImport.ScoutPlanArray.length; i++) {
                        AddScoutPlanRow();

                        $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanExchangePoints`).val(JSONImport.ScoutPlanArray[i].ExchangePoints);
                        $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanGoal`).val(JSONImport.ScoutPlanArray[i].Goal);

                        if (BannersInfo[JSONImport.ScoutPlanArray[i].Banner].GlobalEndDate >= Today) {
                            $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanBanner`).val(JSONImport.ScoutPlanArray[i].Banner);
                            $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanActive`).prop('checked', JSONImport.ScoutPlanArray[i].Active);
                        }
                        else {
                            $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanBanner`).val('');
                            $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanActive`).prop('checked', false);

                            if (JSONImport.ScoutPlanArray[i].Active) {
                                AnnounceExpiredItems = true;
                            };
                        };
                    };
                    
                    if (AnnounceExpiredItems) {
                        swal({icon: 'info', text: 'Expired wish plan row(s) were detected in the import. These row(s) have been automatically set to inactive. All other information has been successfully imported.'});
                    };

                    $('input, select').change().trigger('input');

                    if (RunCalcs == true) {
                        $('#Calculate').trigger('click');
                    }
                    else if (Scroll == true) {
                        $('html, body').animate({
                            scrollTop: $("#CalculatorHeaderAnchor").offset().top,
                            easing: 'linear'
                        }, 500);
                    };
                };
            };

            function Export(){
                if (getInvalidFields().length != 0) {
                    swal({icon: 'error', text: 'Invalid information detected. Cannot generate export.'});
                }
                else {
                    let ExportState = JSON.stringify(CompileForm());
                    var temp = $("<input>");
                    $("body").append(temp);
                    temp.val(ExportState).select();
                    document.execCommand("copy");
                    temp.remove();

                    swal({icon: 'success', text: 'Export copied to clipboard.', timer: 2000});
                };
            };

            $(function () {
                $('a[data-toggle="tooltip"]').each(function() {
                    $(this).tooltip({
                        html: true
                    });
                });
            });

            function SetParsleyValidations() {
                $('input:not([type="checkbox"])').on('input', function(){
                    if (!$(this).parsley().isValid()) {
                        $(this).css('background-color', '#E55451');
                    }
                    else{
                        $(this).css('background-color', 'white');
                    };
                });

                $('input:not([type="checkbox"])').each(function() {
                    $(this).parsley().validate();
                });
            };

            $(function(){
                SetParsleyValidations();

                $('input, select').change().trigger('input');

                let Unsaved = false;
                
                $("input, select").on('change', function() {
                    Unsaved = true;
                });

                window.onbeforeunload = function() {
                    if (Unsaved && !$('#DisableUnsavedChangesWarning').is(':checked')) {
                        return "You have unsaved changes on this page. If you wish to save your changes, then please export them before leaving this page.";
                    };
                };
            });
        </script>
    </body>
</html>