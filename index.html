<!-- TODO: Add comments. -->
<!DOCTYPE html>

<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Umamusume Wish Planning Calculator</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="description" content="" />
        
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
        <script src="Wish_Calculator_JS.mjs" type="text/javascript"></script>

        <script src="https://parsleyjs.org/dist/parsley.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.0/jquery-ui.min.js"></script>
        <script src="assets\js\jquery-ui-touch-punch\jquery.ui.touch-punch.js"></script> <!-- Helps the dragables work on mobile. -->

        <script type="text/javascript">
            let NewWishPlanRowID; // Initializing here so it can be used throughout the whole code and kept consistent.

            // const WishModes = {
            //     'Simple':   {value: 1, text: 'Simple'},
            //     'Normal':   {value: 2, text: 'Normal'},
            //     'Advanced': {value: 3, text: 'Advanced'}
            // };
        </script>
    </head>
    <body>
        <style>
            body, html {
                margin-bottom: 2.5%;
                margin-top: 2.5%;
            }

            body { 
                color: black;
                background-color: #9990a3;
            }

            #LoadingSpinner {
                width: 50px;
                height: 50px;
                border: 3px solid rgba(255,255,255,.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
                -webkit-animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }
            @-webkit-keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }

            ul.parsley-errors-list {
                list-style-type: none;
                padding: 0;
                margin: 0;
                color: #800000;
            }

            i.bi-question-circle {
                color: white;
            }

            .TableField {
                border-color: black;
                font-size: min(3vw, 16px);
            }

            /* td-label is used by table cells and labels when we want an entire table cell to act as a label for a checkbox it contains. */
            td.td-label {
                position: relative;
            }

            td.td-label:hover {
                background-color: #E1EDF0;
            }

            label.td-label {
                position: absolute;
                top: 0%;
                left: 0;
                width: 100%;
                height: 100%;
            }

            .swal-button {
                background-color: #4962B3;
            }

            .swal-button:not([disabled]):hover {
                background-color: #5B71BA;
            }

            .btn-add {
                background: #52B4FA;
            }

            .btn-add:not([disabled]):hover {
                background: #90D5FF;
            }

            #WishPlanningResultsTable {
                width: 75%;
            }

            @media only screen and (max-width: 600px) {
                #WishPlanningResultsTable {
                    width: 100%;
                }
            }
            
            .DisabledWishPlanRow {
                color: gray;
                border-color: gray;
            }
        </style>

        <center><h1>Umamusume Wish Planning Calculator</h1></center>

        <form id="form" data-parsley-validate="true">
            <div class="container">
                <hr><center><h2>Calculator Settings</h2></center><br>

                <div class="accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="ImportExportAccordion">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ImportExportAccordionContent" aria-expanded="false" aria-controls="ImportExportAccordionContent">
                                <h4 class="d-block w-100 text-center">Import/Export</h4>
                            </button>
                        </h2>
                        <div id="ImportExportAccordionContent" class="accordion-collapse collapse" aria-labelledby="ImportExportAccordion" data-bs-parent="#ImportExportAccordion">
                            <div class="accordion-body">
                                <label for="ImportState" class="form-label">
                                    You can click the <b>Export</b> button below to copy all your wish info for future use. When you are ready to use the calculator again, you can paste that info into the text box below and click <b>Import</b> or <b>Import and Run</b>.
                                </label><br>
                                <center>
                                    <textarea id="ImportState" class="form-control" style="border-color: black;" rows="5"></textarea><br>
                                    <p id="InvalidImportMessage" style="color: red; display: none;">Invalid Import.</p>
                                    
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Import(RunCalcs=false, ImportState=$('#ImportState').val(), Scroll=true);">
                                        Import
                                    </a>
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Export();">
                                        Export
                                    </a>
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Import(RunCalcs=true, ImportState=$('#ImportState').val(), Scroll=true);">
                                        Import and Run
                                    </a>
                                    <br>
                                </center>
                            </div>
                        </div>
                    </div>
                </div>
                <br>

                <center>
                    <!-- <label for="WishMode" class="form-label">Wish Mode</label>
                    <a data-toggle="tooltip"
                        title="
                            <ul>
                                <li><b>Simple Mode:</b> Allows you to run the calculator with just your current resources.</li>
                                <li><b>Normal Mode:</b> Allows you to specify how many characters, weapons, and chronicled wish items you will be wishing for and when you will complete your wishing by.</li>
                                <li><b>Advanced Mode:</b> Allows you to specify which items you want to wish for, when you will wish for them by, and in what order.</li>
                            </ul>
                        "
                    >
                        <i class="bi bi-question-circle"></i>
                    </a>
                    <select id="WishMode" class="form-select" style="max-width: 125px;"></select>
                    <script type="text/javascript">
                        for (const [Key, Mode] of Object.entries(WishModes)) {
                            $('#WishMode').append($('<option>', Mode));
                        };
                        $(`#WishMode option[value=${WishModes.Advanced.value}]`).prop('selected', true); // We want advanced to be selected by default but also be the last option.
                    </script> -->
                    <!-- <br> -->

                    <!-- <div class="SimpleModeSkipGroup form-check form-check-inline form-switch">
                        <input type="checkbox" id="EnableEventCalcs" class="form-check-input">
                        <label for="EnableEventCalcs" class="form-label">Factor in events</label>
                        <a data-toggle="tooltip"
                            title="If checked, then the calculator will assume that each patch there will be 1 flagship event, awarding <b>900 Free Carrots</b> and 3 secondary events, each awarding <b>420 Free Carrots</b>."
                        >
                            <i class="bi bi-question-circle"></i>
                        </a>
                        <br>
                    </div> -->

                    <div class="form-check form-check-inline form-switch">
                        <input type="checkbox" id="DisableUnsavedChangesWarning" class="form-check-input">
                        <label for="DisableUnsavedChangesWarning" class="form-label">Disable unsaved changes warning</label>
                    </div>

                    <a id="CalculatorHeaderAnchor"></a>

                    <hr><h2>Currency</h2><br>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="FC" class="form-label">Free Carrots</label><br>
                            <input type="number" id="FC" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="PC" class="form-label">Paid Carrots</label><br>
                            <input type="number" id="PC" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="UmaTicket" class="form-label">Trainee Scout Ticket</label><br>
                            <input type="number" id="UmaTicket" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="CardTicket" class="form-label">Support Card Scout Ticket</label><br>
                            <input type="number" id="CardTicket" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                       <!--  <div class="CurrencyTopRow SimpleModeSkipGroup">
                            <label for="Stardust" class="form-label">Masterless Stardust</label>
                            <a data-toggle="tooltip"
                                title="This will be used to calculate how many of the available <b>Intertwined Fates</b> you can purchase from the <b>Stardust Exchange</b> between now and the <b>Wishing End Date</b>. If left empty then the calculator will assume all available <b>Intertwined Fates</b> can be purchased. It is assumed that this month's <b>Intertwined Fates</b> have already been purchased."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                            <br>
                            <input type="number" id="Stardust" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-min="0" min="0"><br>
                        </div> -->
                    </div>
                    <br>

                    <!-- <div class="form-check form-check-inline form-switch">
                        <input type="checkbox" id="UsingStarglitter" class="form-check-input">
                        <label for="UsingStarglitter" class="form-label">Using Masterless Starglitter</label><br>
                    </div> -->

                    <!-- <div class="row" id="StarglitterSkipGroup" style="display: none;">
                        <div class="col-sm-4">
                            <label for="Starglitter" class="form-label">Masterless Starglitter</label>
                            <input type="number" id="Starglitter" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>
                    
                        <div class="col-sm-4">
                            <label for="MissingFourStarCharacters" class="form-label">Missing 4&#9733; Characters</label>
                            <a data-toggle="tooltip"
                                title="If all 4&#9733; characters have been acquired then every 4&#9733; pulled should give at least 2 Masterless Starglitter. The calculator will assume that a 4&#9733; is given once every 10 wishes, and so if all 4&#9733;s are acquired before or during the wishing process then 2 additional Masterless Starglitter will be awarded per subsequent wish."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                            <br>
                            <input type="number" id="MissingFourStarCharacters" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="40"><br>
                        </div>

                        <div class="col-sm-4">
                            <label for="MissingStandardFiveStarCharacters" class="form-label">Missing Standard Banner 5&#9733; Characters</label>
                            <a data-toggle="tooltip"
                                title="5&#9733; character constellations will award 10 Masterless Starglitter and so if all standard banner 5&#9733;s are acquired before or during the wishing process then 10 additional Masterless Starglitter will be awarded every following time you pull a standard banner 5&#9733;. Additional wishes gained from this won't be reflected in the <b>Max Number of Wishes</b>."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                            <br>
                            <input type="number" id="MissingStandardFiveStarCharacters" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="8"><br>
                        </div>
                    </div> -->

                    <hr><h2>Wishing Info</h2><br>

                    <!-- TODO: Using this as a basis for the banner dropdown to be copied off of -->
                    <select id="BannerEnd" class="form-select" style="max-width: 300px; display: none;"></select>
                    <script type="text/javascript">
                        $(function() {
                            for (let i = 0; i < GlobalBanners.length; i++) {
                                if (GlobalBanners[i].EndDate >= Today) {
                                // console.log('yo')
                                    $('#BannerEnd').append($('<option>', {
                                        value: i,
                                        // ${moment(GlobalBanners[i].BannerEndDate, "YYYY-MM-DD").format('L')}
                                        text: `${GlobalBanners[i].Name}: ${moment(GlobalBanners[i].StartDate, "YYYY-MM-DD").format('L')} - ${moment(GlobalBanners[i].EndDate, "YYYY-MM-DD").format('L')}`,
                                    }));
                                }
                            };
                        });
                    </script>
                    <!-- <div class="SimpleModeSkipGroup BasicWishPlanningSkipGroup">
                        <label for="EndPatch" class="form-label">Wishing End Date</label>
                        <a data-toggle="tooltip"
                            title="Dates are in American server time. The calculator currently assumes that banners end at 12:00 AM (0:00) on the banner end date."
                        >
                            <i class="bi bi-question-circle"></i>
                        </a>
                        <br>
                    </div> -->

                    <!----
                    <table class="table table-bordered" style="font-size: min(3vw, 16px); text-align: center; border: 1px; max-width: 100%;">
                        <thead>
                            <tr>
                                <td></td>
                                <td><b>Character Banner</b></td>
                                <td><b>Weapon Banner</b></td>
                                <td><b>Chronicled Wish</b></td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class='BasicWishPlanningSkipGroup'>
                                <td style="vertical-align: middle;"><b>Number of 5&#9733;s Wishing For</b></td>
                                <td>
                                    <input type="number" id="CharacterGoal" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="WeaponGoal" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="ChronicledGoal" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0">
                                </td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;"><b>Pity</b></td>
                                <td>
                                    <input type="number" id="CharacterPity" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0, 89]" min="0" max="89" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="WeaponPity" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0, 79]" min="0" max="79" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="ChronicledPity" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0, 89]" min="0" max="89" Value="0">
                                </td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;"><b>Event 5&#9733; Guarantee</b></td>
                                <td class="td-label">
                                    <label class="td-label">
                                        <input type="checkbox" id="EventCharacterGuarantee" class="form-check-input TableField align-middle">
                                    </label>
                                </td>
                                <td class="td-label">
                                    <label class="td-label">
                                        <input type="checkbox" id="EventWeaponGuarantee" class="form-check-input TableField align-middle">
                                    </label>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;"><b>Fate Points</b></td>
                                <td></td>
                                <td>
                                    <input type="number" id="WeaponFatePoints" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0, 1]" min="0" max="1" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="ChronicledFatePoints" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0, 1]" min="0" max="1" Value="0">
                                </td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;">
                                    <b id="CapturingRadianceLabel">Capturing Radiance Pity</b>
                                    <a data-toggle="tooltip"
                                        title="
                                            When pulling on a character banner, if you obtain a 5&#9733; character and they are not the event character, you will gain one <b>Capturing Radiance Pity</b>. If you obtain the event character without the <b>Guarantee</b>, then your <b>Capturing Radiance Pity</b> will be reset to 0. Your <b>Capturing Radiance Pity</b> will alter your chances of obtaining the event character, without the <b>Guarantee</b>, as follows:
                                            <br><br>
                                            <ul>
                                                <li> 0 Pity: 50% Chance   </li>
                                                <li> 1 Pity: 52.5% Chance </li>
                                                <li> 2 Pity: 75% Chance   </li>
                                                <li> 3 Pity: 100% Chance  </li>
                                            </ul>
                                            These numbers come from a speculative model, based on wish results observed following this mechanics addition to the game, and as such may not be entirely accurate.
                                        "
                                    >
                                        <i class="bi bi-question-circle" style="color: black;"></i>
                                    </a>
                                    <br>
                                    <div class="form-check form-check-inline form-switch">
                                        <input type="checkbox" id="EnableCapturingRadiance" class="form-check-input TableField">
                                        <label for="EnableCapturingRadiance" class="form-label">Enable</label>
                                    </div>
                                </td>
                                <td>
                                    <div id="CapturingRadiancePitySkipGroup">---> <!-- Wrapping this in a div so parsley validations will also be hidden. -->
                                        <!---<input type="number" id="CapturingRadiancePity" class="form-control TableField" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0, 3]" min="0" max="3" Value="0">
                                    </div>
                                </td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    --->

                    <div style="overflow-x: auto;">
                        <table id="WishPlanningTable" class="table table-bordered table-striped" style="font-size: min(3vw, 16px); text-align: center; border: 1px;">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">
                                        <!-- Veritcal Grip -->
                                    </th>
                                    <!-- <th style="width: 30%; min-width: 175px;">
                                        Name
                                    </th> -->
                                    <!-- <th style="width: 15%; min-width: 155px;">
                                        Banner Type
                                    </th> -->
                                    <th style="width: 60%; min-width: 125px;">
                                        Wishing End Date
                                        <a data-toggle="tooltip"
                                            title="Dates are in American server time. The calculator currently assumes that banners end at 12:00 AM (0:00) on the banner end date."
                                        >
                                            <i class="bi bi-question-circle" style="color: black;"></i>
                                        </a>
                                    </th>
                                    <th style="width: 10%; min-width: 80px;">
                                        Copies
                                    </th>
                                    <th style="width: 10%;">
                                        Enabled
                                    </th>
                                    <th style="width: 10%;">
                                        <!-- Remove Button -->
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="WishPlanningTableBody">
                                <!--- Rows will be added by the script below. --->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="7">
                                        <button id="AddRowButton" type="button" style="width: 100%" class="btn btn-add">
                                            <b><i class="bi bi-plus-lg" style="font-size: 30px; font-weight: bold; color: white;"></i></b>
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <script type="text/javascript">
                        function AddWishPlanRow() {
                            let NewRow = $(
                                `<tr id="WishPlanRow${NewWishPlanRowID}" data-wishplan-rowid="${NewWishPlanRowID}">`+
                                    `<td class="handle" style="vertical-align: middle;"><i class="bi bi-arrows-move" style="font-size: 20px"></i></td>`+
                                    // `<td>`+
                                    //     `<input type="text" class="WishPlanItem form-control" style="width: 100%;">`+
                                    // `</td>`+
                                    // `<td>`+
                                    //     `<center>`+
                                    //         `<select class="WishPlanType form-select">`+ // TODO: See about generating this dynamically.
                                    //             // `<option value=${BannerTypes.Character.value}>      ${BannerTypes.Character.text}      </option>`+
                                    //             // `<option value=${BannerTypes.Weapon.value}>         ${BannerTypes.Weapon.text}         </option>`+
                                    //             // `<option value=${BannerTypes.ChronicledWish.value}> ${BannerTypes.ChronicledWish.text} </option>`+
                                    //         `</select>`+
                                    //     `</center>`+
                                    // `</td>`+
                                    `<td>`+
                                        `<center>`+
                                            `<select class="WishPlanBannerEnd form-select"></select>`+
                                        `</center>`+
                                    `</td>`+
                                    `<td>`+
                                        `<center>`+
                                            `<input type="number" class="WishPlanGoal form-control" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="1" min="1" Value="1">`+
                                        `</center>`+
                                    `</td>`+
                                    `<td class="td-label">`+
                                        `<label class="td-label">`+
                                            `<input type="checkbox" class="WishPlanEnabled form-check-input align-middle" onchange="ToggleWishPlanRow(this, ${NewWishPlanRowID}); UpdateCalculateButton();" checked>`+
                                        `</label>`+
                                    `</td>`+
                                    `<td>`+
                                        `<button type="button" class="btn btn-danger" onclick="$('#WishPlanRow${NewWishPlanRowID}').remove(); UpdateCalculateButton();">`+
                                            `<i class="bi bi-x-lg" style=" font-weight: bold;"></i>`+
                                        `</button>`+
                                    `</td>`+
                                `</tr>`
                            );

                            $('#WishPlanningTableBody').append(NewRow);
                            $('#WishPlanningTableBody').sortable("refresh");

                            $(`tr[data-wishplan-rowid=${NewWishPlanRowID}] .WishPlanBannerEnd`).html($('#BannerEnd').html());
                            $(`tr[data-wishplan-rowid=${NewWishPlanRowID}] input, tr[data-wishplan-rowid=${NewWishPlanRowID}] select`).addClass('WishPlanField TableField');

                            SetParsleyValidations();

                            NewWishPlanRowID++;
                        };

                        $(function() {
                            NewWishPlanRowID = 0;

                            $('#WishPlanningTableBody').sortable({handle: ".handle"});

                            $("#AddRowButton").click(function() {AddWishPlanRow(); UpdateCalculateButton();});

                            // We want the table to load with 3 rows by default.
                            for (let i = 0; i < 3; i++) AddWishPlanRow();
                        });
                    </script>

                    <hr><h2>PVP</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="TeamTrialsClass" class="form-label">Team Trials Class</label>
                            <input type="number" id="TeamTrialsClass" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[1,6]" min="1" max="6" Value="1">
                        </div>

                        <div class="col-md-6">
                            <label for="ExpectedClubRank" class="form-label">Expected Club Ranking</label>
                            <!-- <input type="number" id="ExpectedAct" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,10]" min="0" max="10" Value="0"> -->
                            <select id="ExpectedClubRank" class="form-select" style="max-width: 300px;">
                                <option value="1">SS (1-10)</option>
                                <option value="2">S+ (11-30)</option>
                                <option value="3">S &nbsp;&nbsp;(31-100)</option>
                                <option value="4">A+ (101-500)</option>
                                <option value="5">A &nbsp;&nbsp;(501-100)</option>
                                <option value="6">B+ (1001-3000)</option>
                                <option value="7">B &nbsp;&nbsp;(3001-5000)</option>
                                <option value="8">C+ (5001-7000)</option>
                                <option value="9">C &nbsp;&nbsp;(7001-10000)</option>
                                <option value="10">D+ (10001-30000)</option>
                                <option value="11">D</option>
                            </select>
                        </div>
                    </div>

                    <!-- <div class="SimpleModeSkipGroup"> -->
                        
                    <!-- </div> -->

                    <div class="SimpleModeSkipGroup">
                        <hr>
                        <h2>
                            Daily Carrot Pack
                            <a data-toggle="tooltip"
                                title="This calculator will assume that the <b>Daily Carrot Pack</b> will either be purchased from now until continuously or not at all."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                        </h2>
                        <br>

                        <div class="form-check form-check-inline">
                            <input type="checkbox" id="HasDailyCarrotPack" class="form-check-input">
                            <label for="HasDailyCarrotPack" class="form-label">Purchasing Daily Carrot Pack</label>
                        </div>
                        <!-- <div class="form-check form-check-inline">
                            <input type="checkbox" id="BPPurchased" class="form-check-input">
                            <label for="BPPurchased" class="form-label">Purchasing Battle Pass</label>
                        </div>
                   
                        <div id="BPLevelSkipGroup" class="form-group" style="display: none;">
                            <label for="BPLevel" class="form-label">Battle Pass Level</label>
                            <select id="BPLevel" class="form-select" style="max-width: 100px;">
                                <option value="0"> 0-9   </option>
                                <option value="1"> 10-19 </option>
                                <option value="2"> 20-29 </option>
                                <option value="3"> 30-39 </option>
                                <option value="4"> 40-49 </option>
                                <option value="5"> 50    </option>
                            </select>
                        </div> -->
                    </div>

                    <!-- <div id="EventCalcs">
                        <hr><h2>Events</h2><br>

                        <div class="row">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-3 SecondaryEventsCompletableSkipGroup">
                                <label for="SecondaryEventsCompletable" class="form-label">Secondary Events Completable in First Half</label>
                                <input type="number" id="SecondaryEventsCompletable" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,3]" min="0" max="3" Value="0">
                            </div>
                            <div class="col-sm-3 SecondaryEventsCompletedCtrlGroup">
                                <label for="SecondaryEventsCompleted" class="form-label">Secondary Events Completed</label>
                                <input type="number" id="SecondaryEventsCompleted" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,3]" min="0" max="3" Value="0">
                            </div>
                            <div class="col-sm-3"></div>
                        </div>
                        <br>

                        <div class="form-check form-check-inline FlagshipEventCompletableSkipGroup">
                            <input type="checkbox" id="FlagshipEventCompletable" class="form-check-input">
                            <label for="FlagshipEventCompletable" class="form-label">Flagship Event Completable in First Half</label>
                            <a data-toggle="tooltip"
                                title="The calculator will assume this is false, and the secondary events completable is 1, for any patches after this one."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="checkbox" id="FlagshipEventCompleted" class="form-check-input">
                            <label for="FlagshipEventCompleted" class="form-label">Flagship Event Completed</label>
                        </div>
                        <br><br>

                        <div class="form-check form-check-inline">
                            <input type="checkbox" id="UsingHoyoLabCheckin" class="form-check-input">
                            <label for="UsingHoyoLabCheckin" class="form-label">Using <b>HoYoLAB Community Daily Check-In</b></label>
                            <a data-toggle="tooltip"
                                title="The check-in will award 20 <b>Free Carrots</b> on the 4th, 11th, & 18th of every month."
                            >
                                <i class="bi bi-question-circle"></i>
                            </a>
                        </div>
                    </div> -->

                    <hr><h2>Wish Results</h2><br>

                    <a id="Calculate" class="btn btn-primary" style="border-width: 1px; border-color: black;">Calculate</a>
                </center>
            </div>
            <br>
        </form>

        <div class="container">
            <center>
                <div id="LoadingGroup" style="display: none;">
                    <div id="LoadingSpinner"></div>
                    <br>
                    Loading...
                </div>

                <a id="WishResultsAnchor"></a>
                
                <div id="WishError" class="WishResults" style="display: none; color: #800000;"></div>

                <div id="WishEndDate" class="WishResults" style="display: none;"></div>

                <div id="MaxWishes" class="WishResults" style="display: none;"></div>

                <div id="WishingGoals" class="WishResults" style="display: none;"></div>

                <div id="Chance" class="WishResults" style="display: none;"></div>

                <table id="WishPlanningResultsTable" class="table table-bordered table-striped WishResults" style="font-size: min(3vw, 16px); text-align: center; border: 1px; display: none;">
                    <thead>
                        <tr>
                            <th style="width: 35%">Name</th>
                            <th style="width: 35%">Wishing End Date</th>
                            <th style="width: 10%">Copies</th>
                            <th style="width: 10%">Max Wishes</th>
                            <th style="width: 10%">Chance of Success</th>
                        </tr>
                    </thead>
                    <tbody id="WishPlanningResultsBody"> <!--- Will be filled in by WishCalcs. ---> </tbody>
                    <tfoot id="WishPlanningResultsFoot"> <!--- Will be filled in by WishCalcs. ---> </tfoot>
                </table>

                <hr>
                <p>&#xA9; All rights reserved by Cygames, Inc. Other properties belong to their respective owners.</p>
                <a href="MoreInfo.html" style="color: #054295; margin: 5px;">More info</a>
                <a target="_blank" href="https://github.com/MattG129/Genshin-Wish-Calculator/issues" style="color: #054295; margin: 5px;">Report an issue</a>
            </center>
        </div>

        <script type="text/javascript">
            // When leaving the page, we will save the users form inputs to local storage so that we can import them again after the page has been refreshed. This is needed to reconstruct the wish planning table.
            $(document).on('visibilitychange', function() {
                localStorage.setItem("SessionState", JSON.stringify(CompileForm()));
            });

            $(function() {
                let SessionState = localStorage.getItem("SessionState");

                if (SessionState != null) {
                    // TODO: Add a toggle to turn this off.
                    Import(RunCalcs=false, ImportState=SessionState, Scroll=false);
                };
            });

            function getInvalidFields() {
                let InvalidFields = [];
                
                $('input:not([type="checkbox"])').each(function() {
                    if (!$(this).parsley().isValid() && $(this).is(":visible")) {
                        InvalidFields.push($(this).attr('id'));
                    };
                });

                return InvalidFields;
            };

            let ResultsLoaded = false;
            function UpdateCalculateButton() {
                let CalculateText = ResultsLoaded ? 'Recalculate' : 'Calculate'

                if ( $('tr[data-wishplan-rowid]:not(.DisabledWishPlanRow)').length > 0 ) {
                    $("#Calculate").html(CalculateText);
                    $("#Calculate").removeClass('disabled');
                }
                else {
                    $("#Calculate").html(CalculateText + "<br><span style='font-size: small;'>(Must add wish goals.)</span>");
                    $("#Calculate").addClass('disabled');
                };
            };

            UpdateCalculateButton();
            $('#CharacterGoal, #WeaponGoal, #ChronicledGoal, #WishMode').on('input', UpdateCalculateButton)

            $("#Calculate").on('click', function() {
                $('.WishResults').hide();

                let InvalidFields = getInvalidFields();
                if (InvalidFields.length > 0) {
                    swal({icon: 'error', text: 'Please correct invalid data before running calculations.'});

                    $('html, body').animate({scrollTop: $(`#${InvalidFields[0]}`).offset().top-100, easing: 'linear'}, 250);
                }
                else {
                    setTimeout(function () {$("#Calculate").hide()}, 0);

                    $('#LoadingGroup').show();

                    $('html, body').animate({scrollTop: $("#LoadingGroup").offset().top, easing: 'linear'}, 100);

                    setTimeout(function () {
                        if (WishCalcs(CompileForm()).Success) {
                            ResultsLoaded = true;
                            UpdateCalculateButton();
                        };

                        $('#LoadingGroup').hide();

                        $('html, body').animate({scrollTop: $("#WishResultsAnchor").offset().top, easing: 'linear'}, 250);
                        
                        $("#Calculate").show();
                    }, 500);
                };
            });

            // $(function() { // All events will be completable by the second half of the patch.
            //     if (BannerInfo[CurrentBannerVal].Phase == 2) {
            //         $('.FlagshipEventCompletableSkipGroup').hide();
            //         $('.SecondaryEventsCompletableSkipGroup').hide();
            //         $('.SecondaryEventsCompletedCtrlGroup').removeClass('col-sm-3').addClass('col-sm-6');
            //     }
            // });

            // $('#FlagshipEventCompletable').on('change', function () {
            //     if (BannerInfo[CurrentBannerVal].Phase == 1 && !$('#FlagshipEventCompletable').is(':checked')) {
            //         $('#FlagshipEventCompleted').attr('disabled', true).prop('checked', false);
            //         $('label[for="FlagshipEventCompleted"]').css('color', '#505050');
            //     }
            //     else {
            //         $('#FlagshipEventCompleted').attr('disabled', false);
            //         $('label[for="FlagshipEventCompleted"]').css('color', 'black');
            //     };
            // });

            // $('#SecondaryEventsCompletable').on('change', function() {
            //     let SecondaryEventsMax;
            //     if (BannerInfo[CurrentBannerVal].Phase == 1 && $('#SecondaryEventsCompletable').parsley().isValid()) {
            //         SecondaryEventsMax = $('#SecondaryEventsCompletable').val();
            //     }
            //     else {
            //         SecondaryEventsMax = 3;
            //     };

            //     $('#SecondaryEventsCompleted').attr('max', SecondaryEventsMax).parsley({range: `[0, ${SecondaryEventsMax}]`});
            //     $('#SecondaryEventsCompleted').trigger('input');
            // });

            // $('#WishMode').on('change', function () {
                // $('.CurrencyTopRow').removeClass('col-sm-4').addClass('col-sm-3');
                // $('.SimpleModeSkipGroup').show();
                // $('.BasicWishPlanningSkipGroup').show();
                // $('#WishPlanningTable').hide();

                // if ($('#WishMode').val() == WishModes.Simple.value) {
                    // $('.SimpleModeSkipGroup').hide();
                    // $('.CurrencyTopRow').removeClass('col-sm-3').addClass('col-sm-4');
                // }
                // else if ($('#WishMode').val() == WishModes.Advanced.value) {
                    // $('.BasicWishPlanningSkipGroup').hide();
                    // $('#WishPlanningTable').show();
                // };
            // });

            function ToggleWishPlanRow(caller, WishPlanRowID) {
                if ($(caller).is(':checked')) {
                    $(`tr[data-wishplan-rowid=${WishPlanRowID}], tr[data-wishplan-rowid=${WishPlanRowID}] input, tr[data-wishplan-rowid=${WishPlanRowID}] select`).removeClass('DisabledWishPlanRow');
                }
                else {
                    $(`tr[data-wishplan-rowid=${WishPlanRowID}], tr[data-wishplan-rowid=${WishPlanRowID}] input, tr[data-wishplan-rowid=${WishPlanRowID}] select`).addClass('DisabledWishPlanRow');
                };
            };

            // $('#EnableEventCalcs, #WishMode').on('change', function () {
            //     if ($('#EnableEventCalcs').is(':checked') && $('#WishMode').val() != WishModes.Simple.value) {
            //         $('#EventCalcs').show();
            //     }
            //     else {
            //         $('#EventCalcs').hide();
            //     };
            // });

            // $('#EnableCapturingRadiance').on('change', function () {
            //     if ($('#EnableCapturingRadiance').is(':checked')) {
            //         $('#CapturingRadianceLabel').css('color', 'black');
            //         $('#CapturingRadiancePitySkipGroup').show();
            //     }
            //     else {
            //         $('#CapturingRadianceLabel').css('color', 'gray');
            //         $('#CapturingRadiancePitySkipGroup').hide();
            //     };
            // });

            // $('#UsingStarglitter').on('change', function(){
            //     if ($('#UsingStarglitter').is(':checked')) {
            //         $('#StarglitterSkipGroup').show();
            //     }
            //     else {
            //         $('#StarglitterSkipGroup').hide();
            //     };
            // });

            // $('#BPPurchased').on('change', function(){
            //     if ($('#BPPurchased').is(':checked')) {
            //         $('#BPLevelSkipGroup').show();
            //     }
            //     else {
            //         $('#BPLevelSkipGroup').hide();
            //     };
            // });

            function CompileForm(){
                let FormValues = {};

                $('#form input:not(.WishPlanField), #form select:not(.WishPlanField)').each(function() {
                    if ($(this).is(':checkbox')) {
                        FormValues[this.id] = $(this).is(':checked');
                    }
                    else {
                        FormValues[this.id] = this.value == '' ? '' : Number(this.value);
                    };
                });

                FormValues.WishPlanArray = [];
                $('tr[data-wishplan-rowid]').each(function() {
                    FormValues.WishPlanArray.push({
                        WishPlanItem:             $(this).find('td .WishPlanItem').val(),
                        WishPlanType:      Number($(this).find('td .WishPlanType').val()),
                        WishPlanBannerEnd: Number($(this).find('td .WishPlanBannerEnd').val()),
                        WishPlanGoal:      Number($(this).find('td .WishPlanGoal').val()),
                        WishPlanEnabled:          $(this).find('td .WishPlanEnabled').is(':checked')
                    });
                });

                return FormValues
            };

            function Import(RunCalcs, ImportState, Scroll) {
                let isValidImport = true;
                let JSONImport;

                try {
                    JSONImport = JSON.parse(ImportState);

                    // Since some of the import code explicitly references the wish plan mapper it needs to be defined.
                    if (JSONImport.WishPlanArray == undefined) {
                        isValidImport = false;
                    };
                } catch (error) {
                    isValidImport = false;
                };

                if (!isValidImport) {
                    $('#InvalidImportMessage').show();
                }
                else {
                    $('#InvalidImportMessage').hide();

                    // TODO: This part needs to be revisted once we figure out how to handle banner date inaccuracies.
                    // if (JSONImport.BannerEnd < CurrentBannerVal) {
                    //     if (JSONImport.WishMode != WishModes.Advanced.value) {
                    //         swal({icon: 'info', text: 'Banner end date was not imported as it has already passed. All other fields have been successfully imported.'});
                    //     };

                    //     JSONImport.BannerEnd = CurrentBannerVal;
                    // }
                    // else if (JSONImport.BannerEnd >= BannerInfo.length) {
                    //     if (JSONImport.WishMode != WishModes.Advanced.value) {
                    //         swal({icon: 'info', text: 'Banner end date was not imported as it is too far in the future. All other fields have been successfully imported.'});
                    //     };

                    //     JSONImport.BannerEnd = CurrentBannerVal;
                    // };

                    $('#form input:not(.WishPlanField), #form select:not(.WishPlanField)').each(function() {
                        if ($(this).is(':checkbox')) {
                            $(this).prop('checked', JSONImport[this.id]);
                        }
                        else {
                            $(this).val(JSONImport[this.id]);
                        };
                    });

                    // We will remove the existing wish planning rows to avoid any potential conflicts with the imported ones.
                    $('tr[data-wishplan-rowid]').remove();
                    NewWishPlanRowID = 0;

                    let AnnounceExpiredWishPlanRows = false; // We will only set this to true when there are active expired wish plan rows and advanced wish planning mode is activated.
                    for (let i = 0; i < JSONImport.WishPlanArray.length; i++) {
                        AddWishPlanRow();

                        $(`tr[data-wishplan-rowid=${i}] td .WishPlanItem`).val(JSONImport.WishPlanArray[i].WishPlanItem);
                        $(`tr[data-wishplan-rowid=${i}] td .WishPlanType`).val(JSONImport.WishPlanArray[i].WishPlanType);
                        $(`tr[data-wishplan-rowid=${i}] td .WishPlanGoal`).val(JSONImport.WishPlanArray[i].WishPlanGoal);

                        // if (JSONImport.WishPlanArray[i].WishPlanBannerEnd >= CurrentBannerVal) {
                        //     $(`tr[data-wishplan-rowid=${i}] td .WishPlanBannerEnd`).val(JSONImport.WishPlanArray[i].WishPlanBannerEnd);
                        //     $(`tr[data-wishplan-rowid=${i}] td .WishPlanEnabled`).prop('checked', JSONImport.WishPlanArray[i].WishPlanEnabled);
                        // }
                        // else {
                        //     $(`tr[data-wishplan-rowid=${i}] td .WishPlanBannerEnd`).val(CurrentBannerVal);
                        //     $(`tr[data-wishplan-rowid=${i}] td .WishPlanEnabled`).prop('checked', false);

                        //     if (JSONImport.WishMode == WishModes.Advanced.value && JSONImport.WishPlanArray[i].WishPlanEnabled) {
                        //         AnnounceExpiredWishPlanRows = true;
                        //     };
                        // };
                    };
                    
                    if (AnnounceExpiredWishPlanRows) {
                        swal({icon: 'info', text: 'Expired wish plan row(s) were detected in the import. These row(s) have been automatically set to inactive. All other information has been successfully imported.'});
                    };

                    $('input, select').change().trigger('input');

                    if (RunCalcs == true) {
                        $('#Calculate').trigger('click');
                    }
                    else if (Scroll == true) {
                        $('html, body').animate({
                            scrollTop: $("#CalculatorHeaderAnchor").offset().top,
                            easing: 'linear'
                        }, 500);
                    };
                };
            };

            function Export(){
                if (getInvalidFields().length != 0) {
                    swal({icon: 'error', text: 'Invalid information detected. Cannot generate export.'});
                }
                else {
                    let ExportState = JSON.stringify(CompileForm());
                    var temp = $("<input>");
                    $("body").append(temp);
                    temp.val(ExportState).select();
                    document.execCommand("copy");
                    temp.remove();

                    swal({icon: 'success', text: 'Export copied to clipboard.', timer: 2000});
                };
            };

            $(function () {
                $('a[data-toggle="tooltip"]').each(function() {
                    $(this).tooltip({
                        html: true
                    });
                });
            });

            function SetParsleyValidations() {
                $('input:not([type="checkbox"])').on('input', function(){
                    if (!$(this).parsley().isValid()) {
                        $(this).css('background-color', '#E55451');
                    }
                    else{
                        $(this).css('background-color', 'white');
                    };
                });

                $('input:not([type="checkbox"])').each(function() {
                    $(this).parsley().validate();
                });
            };

            $(function(){
                SetParsleyValidations();

                $('input, select').change().trigger('input');

                let Unsaved = false;
                
                $("input, select").on('change', function() {
                    Unsaved = true;
                });

                window.onbeforeunload = function() {
                    if (Unsaved && !$('#DisableUnsavedChangesWarning').is(':checked')) {
                        return "You have unsaved changes on this page. If you wish to save your changes, then please export them before leaving this page.";
                    };
                };
            });
        </script>
    </body>
</html>