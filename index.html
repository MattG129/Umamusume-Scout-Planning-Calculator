<!DOCTYPE html>

<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Umamusume Scout Planning Calculator</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="description" content="" />
        
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="BoilerPlate.js" type="text/javascript"></script>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
        <script src="BannersInfo.js" type="text/javascript"></script>
        <script src="ScoutCalcs.mjs" type="text/javascript"></script>

        <script src="https://parsleyjs.org/dist/parsley.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.0/jquery-ui.min.js"></script>
        <script src="assets\js\jquery-ui-touch-punch\jquery.ui.touch-punch.js"></script> <!-- Helps the dragables work on mobile. -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

        <script type="text/javascript">
            let Page = 'index';

            let NewScoutPlanRowID; // Initializing here so it can be used throughout the whole code and kept consistent.
        </script>
    </head>
    <body>
        <style>
            body, html {
                margin-bottom: 2.5%;
                margin-top: 2.5%;
            }

            body { 
                color: black;
                background-color: #9990a3;
            }

            #LoadingSpinner {
                width: 50px;
                height: 50px;
                border: 3px solid rgba(255,255,255,.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
                -webkit-animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }
            @-webkit-keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }

            ul.parsley-errors-list {
                list-style-type: none;
                padding: 0;
                margin: 0;
                color: #800000;
            }

            i.bi-question-circle {
                color: white;
            }

            .TableField {
                border-color: black;
                font-size: min(3vw, 16px);
            }

            /* td-label is used by table cells and labels when we want an entire table cell to act as a label for a checkbox it contains. */
            td.td-label {
                position: relative;
            }

            td.td-label:hover {
                background-color: #E1EDF0;
            }

            label.td-label {
                position: absolute;
                top: 0%;
                left: 0;
                width: 100%;
                height: 100%;
            }

            .swal-button {
                background-color: #4962B3;
            }

            .swal-button:not([disabled]):hover {
                background-color: #5B71BA;
            }

            .btn-add {
                background: #52B4FA;
            }

            .btn-add:not([disabled]):hover {
                background: #90D5FF;
            }

            #ScoutPlanningResultsTable {
                width: 75%;
            }

            @media only screen and (max-width: 600px) {
                #ScoutPlanningResultsTable {
                    width: 100%;
                }
            }
            
            .InactiveScoutPlanRow {
                color: gray;
                border-color: gray;
            }

            .select2-container .select2-selection--multiple .select2-selection__choice {
                max-width: 100%;
                box-sizing: border-box;
                white-space: normal;
                word-wrap: break-word;
            }

            .select2-dropdown {
                top: 32px; /*Moves the select2 dropdown down since it would otherwise be too high up for some reason.*/
            }

            .select2-search__field::placeholder {
                text-align: center;
            }
        </style>

        <div id='Header'></div>

        <form id="form" data-parsley-validate="true">
            <div class="container">
                <hr><center><h2>Calculator Settings</h2></center><br>

                <div class="accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="ImportExportAccordion">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ImportExportAccordionContent" aria-expanded="false" aria-controls="ImportExportAccordionContent">
                                <h4 class="d-block w-100 text-center">Import/Export</h4>
                            </button>
                        </h2>
                        <div id="ImportExportAccordionContent" class="accordion-collapse collapse" aria-labelledby="ImportExportAccordion" data-bs-parent="#ImportExportAccordion">
                            <div class="accordion-body">
                                <label for="ImportState" class="form-label">
                                    You can click the <b>Export</b> button below to copy all your scout planning info for future use. When you are ready to use the calculator again, you can paste that info into the text box below and click <b>Import</b> or <b>Import and Run</b>.
                                </label><br>
                                <center>
                                    <textarea id="ImportState" class="form-control" style="border-color: black;" rows="5"></textarea><br>
                                    <p id="InvalidImportMessage" style="color: red; display: none;">Invalid Import.</p>
                                    
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Import(RunCalcs=false, ImportState=$('#ImportState').val(), Scroll=true);">
                                        Import
                                    </a>
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Export();">
                                        Export
                                    </a>
                                    <a class="btn btn-primary" style="border-color: black; margin-bottom: 3px;" onclick="Import(RunCalcs=true, ImportState=$('#ImportState').val(), Scroll=true);">
                                        Import and Run
                                    </a>
                                    <br>
                                </center>
                            </div>
                        </div>
                    </div>
                </div>
                <br>

                <center>
                    <div class="form-check form-check-inline form-switch">
                        <input type="checkbox" id="DisableUnsavedChangesWarning" class="form-check-input">
                        <label for="DisableUnsavedChangesWarning" class="form-label">Disable unsaved changes warning</label>
                    </div>

                    <a id="CalculatorHeaderAnchor"></a>

                    <hr><h2>Currency</h2><br>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="FC" class="form-label">Free Carats</label>
                            <input type="number" id="FC" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="PC" class="form-label">Paid Carats</label>
                            <input type="number" id="PC" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="UmaTickets" class="form-label">Trainee Scout Ticket</label>
                            <input type="number" id="UmaTickets" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                        <div class="col-md-3">
                            <label for="CardTickets" class="form-label">Support Card Scout Ticket</label>
                            <input type="number" id="CardTickets" class="form-control" style="max-width: 300px;" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>
                    </div>
                    <br>

                    <hr><h2>PVP</h2><br>
                    <div class="row">
                        <div class="col-md-3">
                            <h3>Team Trials</h3>
                            <label for="TeamTrialsClass" class="form-label">Team Trials Class</label>
                            <input type="number" id="TeamTrialsClass" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[1,6]" min="1" max="6" Value="1">
                        </div>

                        <div class="col-md-6">
                            <h3>
                                Champions Meeting <a data-toggle="tooltip" title="The calculator will assume that Champions Meeting rewards will be given once per month and at the end of the month."><i class="bi bi-question-circle"></i></a>
                            </h3>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline" style="max-width: 300px; margin-bottom: 15px">
                                        <input type="checkbox" id="CurrentMonthsCMCompleted" class="form-check-input">
                                        <label for="CurrentMonthsCMCompleted" class="form-label">Current Month's Completed</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="CMLeague" class="form-label">League</label>
                                    <select id="CMLeague" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                        <option value="1">Open</option>
                                        <option value="2">Graded</option>
                                    </select>
                                </div>
                            </div>

                            <h4>Round 1</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="CMR1Sets" class="form-label">Number of Sets</label>
                                    <input type="number" id="CMR1Sets" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,8]" min="0" max="8" Value="0">
                                </div>
                                    
                                <div class="col-md-6">
                                    <label for="CMR1WR" class="form-label">Win Rate (%)</label>
                                    <input type="number" id="CMR1WR" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,100]" min="0" max="100" Value="0">
                                </div>
                            </div>


                            <h4>Round 2</h4>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="CMR2Group" class="form-label">Group</label>
                                    <select id="CMR2Group" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                        <option value="1">A</option>
                                        <option value="2">B</option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label for="CMR2Sets" class="form-label">Number of Sets</label>
                                    <input type="number" id="CMR2Sets" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,8]" min="0" max="8" Value="0">
                                </div>

                                <div class="col-md-4">
                                    <label for="CMR2WR" class="form-label">Win Rate (%)</label>
                                    <input type="number" id="CMR2WR" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[0,100]" min="0" max="100" Value="0">
                                </div>
                            </div>

                            <h4>Round 3</h4>
                            <div class="row">
                                <div class="col-md-6">
                                   
                                    <label for="CMR3Group" class="form-label">Group</label>
                                    <select id="CMR3Group" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                        <option value="1">A</option>
                                        <option value="2">B</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="CMR3Placement" class="form-label">Placement</label>
                                    <input type="number" id="CMR3Placement" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-trigger="input" data-parsley-required="true" data-parsley-range="[1,3]" min="1" max="3" Value="3">
                                </div>
                            </div>

                        </div>

                        <div class="col-md-3">
                            <h3>Club Rewards</h3>
                            <label for="ExpectedClubRank" class="form-label">Expected Club Ranking</label>
                            <a data-toggle="tooltip" title="The grade ranking ranges have not been pulled from any official sources, and as such may not be entirely accurate."><i class="bi bi-question-circle"></i></a>
                            <select id="ExpectedClubRank" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                <option value="1">SS (1-10)</option>
                                <option value="2">S+ (11-30)</option>
                                <option value="3">S &nbsp;&nbsp;(31-100)</option>
                                <option value="4">A+ (101-500)</option>
                                <option value="5">A &nbsp;&nbsp;(501-100)</option>
                                <option value="6">B+ (1001-3000)</option>
                                <option value="7">B &nbsp;&nbsp;(3001-5000)</option>
                                <option value="8">C+ (5001-7000)</option>
                                <option value="9">C &nbsp;&nbsp;(7001-10000)</option>
                                <option value="10">D+ (10001-30000)</option>
                                <option value="11">D &nbsp;&nbsp;(> 30000)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <hr>
                        <h2>
                            Events <a data-toggle="tooltip" title="The calculator will assume that Event rewards will be given once per month and at the end of the month."><i class="bi bi-question-circle"></i></a>
                        </h2>
                        <br>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="btn-group-vertical" style="max-width: 300px; margin-bottom: 15px">
                                    Event Content Usually Completed:

                                    <div class="form-check form-check-inline">
                                        <input type="checkbox" id="CompletesEventStories" class="form-check-input">
                                        <label for="CompletesEventStories" class="form-label">Stories</label>
                                    </div>

                                    <div class="form-check form-check-inline">
                                        <input type="checkbox" id="CompletesEventBingoCards" class="form-check-input">
                                        <label for="CompletesEventBingoCards" class="form-label">Bingo Cards</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label for="ExpectedEventPoints" class="form-label">Expected Event Points</label>
                                <select id="ExpectedEventPoints" class="form-select" style="max-width: 300px; margin-bottom: 15px">
                                    <option value="0">0 - 99,999</option>
                                    <option value="1">100,000 - 104,999</option>
                                    <option value="2">105,000 - 174,999</option>
                                    <option value="3">175,000 - 194,999</option>
                                    <option value="4">195,000 - 299,999</option>
                                    <option value="5">300,000 - 459,999</option>
                                    <option value="6">460,000 - 539,999</option>
                                    <option value="7">540,000 - 599,999</option>
                                    <option value="8">600,000 - 699,999</option>
                                    <option value="9">700,000+</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <div class="form-check form-check-inline" style="max-width: 300px; margin-bottom: 15px">
                                    <input type="checkbox" id="CurrentMonthsEventCompleted" class="form-check-input">
                                    <label for="CurrentMonthsEventCompleted" class="form-label">Current Month's Completed</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <hr>
                        <h2>
                            Daily Carat Pack <a data-toggle="tooltip" title="This calculator will assume that the Daily Carat Pack will either be purchased continuously, from the next renewal date onward, or not at all."><i class="bi bi-question-circle"></i></a>
                        </h2>
                        <br>

                        <div class="form-check form-check-inline">
                            <input type="checkbox" id="HasDailyCaratPack" class="form-check-input">
                            <label for="HasDailyCaratPack" class="form-label">Purchasing Daily Carat Pack</label>
                        </div>
                        <br>

                        <!-- Not my best work. -->
                        <!-- TODO: Make this field better. -->
                        <div id="CaratPackRenewalDateSkipGroup" style="display: none;">
                            <label for="NextCaratPackRenewalDate" class="form-label">Next Renewal Date</label>
                            <input id="NextCaratPackRenewalDate" type="date" class="form-control" style="max-width: 300px; margin-bottom: 15px" data-parsley-required="true">
                        </div>

                        <script type="text/javascript">
                            $(function() {
                                $('#NextCaratPackRenewalDate').attr('min', moment(Today).format("YYYY-MM-DD"));
                            });

                            $('#HasDailyCaratPack').change(function() {
                                if ( $('#HasDailyCaratPack').is(':checked') ) {
                                    $('#CaratPackRenewalDateSkipGroup').show();
                                }
                                else {
                                    $('#CaratPackRenewalDateSkipGroup').hide();
                                };
                            });
                        </script>
                    </div>

                    <hr><h2>Scout Planning</h2><br>

                    <div style="overflow-x: auto;">
                        <table id="ScoutPlanningTable" class="table table-bordered table-striped" style="font-size: min(3vw, 16px); text-align: center; border: 1px;">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">
                                        <!-- Vertical Grip -->
                                    </th>
                                    <th style="width: 25%; min-width: 80px;">
                                        Banner
                                    </th>
                                    <th style="width: 25%; min-width: 125px;"> <!-- TODO: Make the accel rate dynamic. -->
                                        Scout Target <a data-toggle="tooltip" title="The calculator currently assumes that banners start/end at 12:00 AM (00:00). Dates are calculated based on the number of days between the Japanese server's launch and the banner's start date on that server. This number is then divided by the global acceleration rate (1.4) and is used to estimate the banner's global start date, based on the global server's launch date. The banner duration remains unchanged. For banners that have already been announced, the global dates will be entered manually."><i class="bi bi-question-circle" style="color: black;"></i></a>
                                    </th>
                                    <th style="width: 10%; min-width: 80px;">
                                        Exchange Points
                                    </th>
                                    <th style="width: 10%; min-width: 80px;">
                                        Copies
                                    </th>
                                    <th style="width: 10%;">
                                        Active
                                    </th>
                                    <th style="width: 10%;">
                                        <!-- Remove Button -->
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="ScoutPlanningTableBody">
                                <tr id="ScoutPlanningLoadingMessage"><td colspan="7">Loading...</td></tr>

                                <!--- Rows will be added by the script below. --->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="7">
                                        <button id="AddRowButton" type="button" style="width: 100%" class="btn btn-add">
                                            <b><i class="bi bi-plus-lg" style="font-size: 30px; font-weight: bold; color: white;"></i></b>
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Using this as a basis for the various scout planning banner dropdowns to be copied off of. -->
                    <select id="BannerTemplate" class="form-select" style="display: none;"></select>
                    <script type="text/javascript">
                        $(function() {
                            for (let i = 0; i < ItemsInfo.length; i++) {
                                if (ItemsInfo[i].GlobalEndDate >= Today && ItemsInfo[i].Disabled != true) {
                                    $('#BannerTemplate').append($('<option>', {
                                        value: i,
                                        text: `${ItemsInfo[i].Name}: ${moment(ItemsInfo[i].GlobalStartDate, "YYYY-MM-DD").format('L')} - ${moment(ItemsInfo[i].GlobalEndDate, "YYYY-MM-DD").format('L')}`,
                                    }));
                                };
                            };
                        });
                    </script>

                    <script type="text/javascript">
                        function AddScoutPlanRow() {
                            let NewRow = $(
                                `<tr id="ScoutPlanRow${NewScoutPlanRowID}" data-scoutplan-rowid="${NewScoutPlanRowID}">
                                    <td class="handle" style="vertical-align: middle;"><i class="bi bi-arrows-move" style="font-size: 20px"></i></td>
                                    <td>
                                        <div class="ScoutPlanBanner" data-banner-id="0"></div>

                                        <div class="OutOfOrderMessage TableValidation" style="color: #800000; display: none;">Banner end dates must be in chronological order.</div>
                                        <div class="DuplicateBannerMessage TableValidation" style="color: #800000; display: none;">Duplicate banner.</div>
                                    </td>
                                    <td>
                                        <center>
                                            <select class="ScoutPlanItems form-select" onchange="UpdateScoutPlanningTable(); UpdateGoalFields(${NewScoutPlanRowID});" data-parsley-required="true" multiple="multiple"></select>
                                        </center>
                                    </td>
                                    <td>
                                        <center>
                                            <input type="number" class="ScoutPlanExchangePoints form-control" data-parsley-trigger="input" data-parsley-required="true" Value="0" min="0" max="199" data-parsley-range="[0,199]">
                                        </center>
                                    </td>
                                    <td class="ScoutPlanGoalsCell"></td>
                                    <td class="td-label">
                                        <label class="td-label">
                                            <input type="checkbox" class="ScoutPlanActive form-check-input align-middle" onchange="ToggleScoutPlanRow(this, ${NewScoutPlanRowID}); UpdateScoutPlanningTable();" checked>
                                        </label>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger" onclick="$('#ScoutPlanRow${NewScoutPlanRowID}').remove(); UpdateScoutPlanningTable();">
                                            <i class="bi bi-x-lg" style=" font-weight: bold;"></i>
                                        </button>
                                    </td>
                                </tr>`
                            );

                            $('#ScoutPlanningTableBody').append(NewRow);
                            $('#ScoutPlanningTableBody').sortable("refresh");

                            $(`tr[data-scoutplan-rowid=${NewScoutPlanRowID}] .ScoutPlanGoalsCell`).sortable();
                            $(`tr[data-scoutplan-rowid=${NewScoutPlanRowID}] .ScoutPlanItems`).html($('#BannerTemplate').html()).select2(Select2Config);
                            $(`tr[data-scoutplan-rowid=${NewScoutPlanRowID}] input, tr[data-scoutplan-rowid=${NewScoutPlanRowID}] select`).addClass('ScoutPlanField TableField');

                            SetParsleyValidations();

                            NewScoutPlanRowID++;
                        };

                        let Select2Config = {
                            closeOnSelect: false,
                            placeholder: "Please Select",
                            templateSelection: function (data) {
                                return ItemsInfo[data.id].Name; // We won't need the date range once an item is selected since it will be displayed in the banner column.
                            },
                            matcher: function(params, data) {
                                if (!data.disabled && ($.trim(params.term) == '' || data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1)) {
                                    return data;
                                }
                                else {
                                    return null;
                                };
                            }
                        };
                        
                        function UpdateGoalFields(RowID) {
                            let Items = $(`tr[data-scoutplan-rowid=${RowID}] .ScoutPlanItems`).val();
                            let GoalsCell = $(`tr[data-scoutplan-rowid=${RowID}] .ScoutPlanGoalsCell`);
                            let GoalLabels = GoalsCell.find('label'); // Using labels since we're gonna wrap the goal fields in them. This way we don't have to remove both.

                            if (Items.length > GoalLabels.length) { // Add goal fields.
                                for (let i = 0; i < Items.length; i++) {
                                    let ItemID = Items[i];

                                    if (GoalsCell.find(`label[data-item-id=${ItemID}]`).length == 0) {
                                        GoalsCell.append($(`
                                            <label class="form-label" data-item-id=${ItemID}>
                                                ${ItemsInfo[ItemID].Name}
                                                <input type="number" class="ScoutPlanGoal ScoutPlanField TableField form-control" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="1" min="1" Value="1">
                                            </label>
                                        `))
                                    };
                                };
                            }
                            else if (Items.length < GoalLabels.length) { // Remove goal fields.
                                GoalLabels.each(function() {
                                    if (!Items.includes($(this).attr('data-item-id'))) {
                                        $(this).remove();
                                    };
                                });
                            };
                        };

                        $(function() {
                            NewScoutPlanRowID = 0;

                            $('#ScoutPlanningTableBody').sortable({
                                handle: ".handle",
                                update: function() {UpdateScoutPlanningTable()}
                            });

                            $("#AddRowButton").click(function() {AddScoutPlanRow(); UpdateScoutPlanningTable();});

                            if (localStorage.getItem("SessionState") == null) {
                                // We want the table to load with 3 rows by default. We will also have these rows use the 3 closest banners and select up to 2 items from that banner.
                                let First = true;
                                let Selected = [];
                                let PreviousBannerID = 0;
                                for (let i = 0; i < ItemsInfo.length; i++) {
                                    if (ItemsInfo[i].GlobalEndDate >= Today && ItemsInfo[i].Disabled != true) {
                                        if (ItemsInfo[i].BannerID != PreviousBannerID) {
                                            if (!First) {
                                                $(`tr[data-scoutplan-rowid=${NewScoutPlanRowID-1}] td .ScoutPlanItems`).val(Selected);
                                            };
                                            First = false;

                                            if (NewScoutPlanRowID >= 3) {
                                                break;
                                            };

                                            Selected = [];
                                            PreviousBannerID = ItemsInfo[i].BannerID;
                                            AddScoutPlanRow();
                                        };

                                        if (Selected.length < 2) {
                                            Selected.push(i);
                                        };
                                    };
                                };

                                $('#ScoutPlanningLoadingMessage').remove();
                            };
                        });

                        let USPTTimeout; // Prevents the import from triggering this function several times.
                        function UpdateScoutPlanningTable() {
                            clearTimeout(USPTTimeout);

                            USPTTimeout = setTimeout(function() {
                                $('.TableValidation').hide();

                                let Banners = [];
                                let PreviousRowFirstItem = -1;
                                $('tr[data-scoutplan-rowid]').each(function() {

                                    let ScoutItems = $(this).find('.ScoutPlanItems').select2('data');

                                    let BannerID = 0;
                                    if (ScoutItems.length > 0) {
                                        BannerID = ItemsInfo[(ScoutItems[0].id)].BannerID;
                                    };

                                    $(this).find('.ScoutPlanBanner').html(BannerID == 0 ? '' : BannerNames[BannerID]);

                                    if ($(this).find('.ScoutPlanActive').is(':checked')) {

                                        if (BannerID != $(this).find('.ScoutPlanBanner').attr('data-banner-id')) {
                                            if (BannerID == 0) {
                                                $(this).find('.ScoutPlanItems option').prop('disabled', false);
                                            }
                                            else {
                                                for (let i = 0; i < ItemsInfo.length; i++) {
                                                    if (ItemsInfo[i].BannerID != BannerID) {
                                                        $(this).find(`.ScoutPlanItems option[value=${i}]`).prop('disabled', true);
                                                    };
                                                };
                                            };

                                            $(this).find('.ScoutPlanItems').select2('close').select2("destroy").select2(Select2Config)
                                        };

                                        $(this).find('.ScoutPlanBanner').attr('data-banner-id', BannerID);

                                        if (BannerID != 0) {
                                            let FirstItem = ScoutItems[0].id

                                            if (PreviousRowFirstItem != -1) {
                                                if (ItemsInfo[FirstItem].GlobalEndDate < ItemsInfo[PreviousRowFirstItem].GlobalEndDate) {
                                                    $(this).find('.OutOfOrderMessage').show();
                                                };
                                            };

                                            if (!Banners.includes(BannerID)) {
                                                Banners.push(BannerID);
                                            }
                                            else {
                                                $(this).find('.DuplicateBannerMessage').show();
                                            };

                                            PreviousRowFirstItem = FirstItem;
                                        };
                                    };
                                });

                                UpdateCalculateButton();
                            }, 10)
                        };
                    </script>

                    <hr><h2>Scout Results</h2><br>

                    <a id="Calculate" class="btn btn-primary" style="border-width: 1px; border-color: black;">Calculate</a>
                </center>
            </div>
            <br>
        </form>

        <div class="container">
            <center>
                <div id="LoadingGroup" style="display: none;">
                    <div id="LoadingSpinner"></div>
                    <br>
                    Loading...
                </div>

                <a id="ScoutResultsAnchor"></a>

                <table id="ScoutPlanningResultsTable" class="table table-bordered table-striped ScoutResults" style="font-size: min(3vw, 16px); text-align: center; border: 1px; display: none;">
                    <thead>
                        <tr>
                            <th style="width: 40%">Scout Target</th>
                            <th style="width: 20%">Copies</th>
                            <th style="width: 20%">Maximum Possible Scouts</th>
                            <th style="width: 20%">Chance of Success</th>
                        </tr>
                    </thead>
                    <tbody id="ScoutPlanningResultsBody"> <!--- Will be filled in by ScoutPlanningCalculator. ---> </tbody>
                    <tfoot> <!--- Will be filled in by ScoutPlanningCalculator. ---> </tfoot>
                </table>

                <hr>
                <div id="Footer"></div>
            </center>
        </div>

        <script type="text/javascript">
            // When leaving the page, we will save the users form inputs to local storage so that we can import them again after the page has been refreshed. This is needed to reconstruct the scout planning table.
            $(document).on('visibilitychange', function() {
                localStorage.setItem("SessionState", JSON.stringify(CompileForm()));
            });

            $(function() {
                let SessionState = localStorage.getItem("SessionState");

                if (SessionState != null) {
                    // TODO: Add a toggle to turn this off.
                    Import(RunCalcs=false, ImportState=SessionState, Scroll=false);

                    $('#ScoutPlanningLoadingMessage').remove();
                    UpdateScoutPlanningTable();
                };
            });

            function getInvalidFields() {
                let InvalidFields = [];
                
                $('input:not([type="checkbox"]), select').each(function() {
                    if (!$(this).parsley().isValid() && $(this).is(":visible")) {
                        InvalidFields.push($(this).attr('id'));
                    };
                });

                return InvalidFields;
            };

            let ResultsLoaded = false;
            function UpdateCalculateButton() {
                let CalculateText = ResultsLoaded ? 'Recalculate' : 'Calculate'

                if (
                    $('tr[data-scoutplan-rowid]:not(.InactiveScoutPlanRow)').length > 0
                    && $('tr[data-scoutplan-rowid]').find('.TableValidation:visible').length == 0
                ) {
                    $("#Calculate").html(CalculateText);
                    $("#Calculate").removeClass('disabled');
                }
                else {
                    $("#Calculate").html(CalculateText);
                    $("#Calculate").addClass('disabled');
                };
            };

            UpdateCalculateButton();

            $("#Calculate").on('click', function() {
                $('.ScoutResults').hide();

                let InvalidFields = getInvalidFields();
                if (InvalidFields.length > 0) {
                    swal({icon: 'error', text: 'Please correct invalid data before running calculations.'});

                    if (InvalidFields[0] != null) { // Prevents scrolling for scout plan fields since they don't have IDs.
                        $('html, body').animate({scrollTop: $(`#${InvalidFields[0]}`).offset().top-100, easing: 'linear'}, 250);
                    };
                }
                else {
                    setTimeout(function () {$("#Calculate").hide()}, 0);

                    $('#LoadingGroup').show();

                    $('html, body').animate({scrollTop: $("#LoadingGroup").offset().top, easing: 'linear'}, 100);

                    setTimeout(function () {
                        if (ScoutPlanningCalculator(CompileForm()).Success) {
                            ResultsLoaded = true;
                            UpdateCalculateButton();
                        };

                        $('#LoadingGroup').hide();

                        $('html, body').animate({scrollTop: $("#ScoutResultsAnchor").offset().top, easing: 'linear'}, 250);
                        
                        $("#Calculate").show();
                    }, 500);
                };
            });

            function ToggleScoutPlanRow(caller, ScoutPlanRowID) {
                if ($(caller).is(':checked')) {
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}], tr[data-scoutplan-rowid=${ScoutPlanRowID}] input`).removeClass('InactiveScoutPlanRow');
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}] .ScoutPlanBanner`).css('color', 'black');
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}] .ScoutPlanItems`).prop("disabled", false);;
                }
                else {
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}], tr[data-scoutplan-rowid=${ScoutPlanRowID}] input`).addClass('InactiveScoutPlanRow');
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}] .ScoutPlanBanner`).css('color', 'gray');
                    $(`tr[data-scoutplan-rowid=${ScoutPlanRowID}] .ScoutPlanItems`).prop("disabled", true);;
                };
            };

            function CompileForm(){
                let FormValues = {};

                $('#form input:not(.ScoutPlanField), #form select:not(.ScoutPlanField)').each(function() {
                    if ($(this).is(':checkbox')) {
                        FormValues[this.id] = $(this).is(':checked');
                    }
                    else if ($(this).attr('type') == 'date') {
                        FormValues[this.id] = this.value;
                    }
                    else {
                        FormValues[this.id] = this.value == '' ? '' : Number(this.value);
                    };
                });

                FormValues.ScoutPlanArray = [];
                $('tr[data-scoutplan-rowid]').each(function() {
                    let Items = [];
                    let Goals = {};
                    $(this).find('label[data-item-id]').each(function() {
                        Items.push($(this).attr('data-item-id'));
                        Goals[$(this).attr('data-item-id')] = $(this).find('.ScoutPlanGoal').val();
                    });

                    if (Items.length > 0) {
                        FormValues.ScoutPlanArray.push({
                            Items: Items,
                            Goals: Goals,
                            ExchangePoints: Number($(this).find('td .ScoutPlanExchangePoints').val()),
                            Active: $(this).find('td .ScoutPlanActive').is(':checked')
                        });
                    };
                });

                return FormValues
            };

            function Import(RunCalcs, ImportState, Scroll) {
                let isValidImport = true;
                let JSONImport;

                try {
                    JSONImport = JSON.parse(ImportState);

                    // Since some of the import code explicitly references the scout plan array it needs to be defined.
                    if (JSONImport.ScoutPlanArray == undefined) {
                        isValidImport = false;
                    };
                } catch (error) {
                    isValidImport = false;
                };

                if (!isValidImport) {
                    $('#InvalidImportMessage').show();
                }
                else {
                    $('#InvalidImportMessage').hide();

                    $('#form input:not(.ScoutPlanField), #form select:not(.ScoutPlanField)').each(function() {
                        if ($(this).is(':checkbox')) {
                            $(this).prop('checked', JSONImport[this.id]);
                        }
                        else {
                            $(this).val(JSONImport[this.id]);
                        };
                    });

                    // We will remove the existing scout planning rows to avoid any potential conflicts with the imported ones.
                    $('tr[data-scoutplan-rowid]').remove();
                    NewScoutPlanRowID = 0; // We will set this to zero so that each row's id will line up with the scout plan item's index.

                    let ExpiredActiveItems = [];
                    for (let i = 0; i < JSONImport.ScoutPlanArray.length; i++) {
                        let ScoutPlanBanner = JSONImport.ScoutPlanArray[i];
                        let FirstItem = ScoutPlanBanner.Items[0];

                        if (FirstItem <= 0 || FirstItem >= ItemsInfo.length) {
                            NewScoutPlanRowID++; // We want to keep this synced with i.
                        }
                        else if (ItemsInfo[FirstItem].GlobalEndDate < Today) {
                            NewScoutPlanRowID++;

                            if (ScoutPlanBanner.Active) {
                                for (let j = 0; j < ScoutPlanBanner.Items.length; j++) {
                                    ExpiredActiveItems.push(ScoutPlanBanner.Items[j]) ;
                                };
                            };
                        }
                        else {
                            AddScoutPlanRow();

                            $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanItems`).val(ScoutPlanBanner.Items);
                            $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanExchangePoints`).val(ScoutPlanBanner.ExchangePoints);
                            $(`tr[data-scoutplan-rowid=${i}] td .ScoutPlanActive`).prop('checked', ScoutPlanBanner.Active);

                            /* This is similar to the code used by UpdateGoalFields to add a goal field, but we removed some if statements that wouldn't be needed in this
                            context, added the ability the specify goal value (instead of it defaulting to 1), and we want to use the item array from the import, as this will
                            allow us to order the goal fields correctly. */
                            let GoalsCell = $(`tr[data-scoutplan-rowid=${i}]`).find('.ScoutPlanGoalsCell');
                            for (let j = 0; j < ScoutPlanBanner.Items.length; j++) {
                                let ItemID = ScoutPlanBanner.Items[j];

                                GoalsCell.append($(`
                                    <label class="form-label" data-item-id=${ItemID}>
                                        ${ItemsInfo[ItemID].Name}
                                        <input type="number" class="ScoutPlanGoal ScoutPlanField TableField form-control" data-parsley-trigger="input" data-parsley-required="true" data-parsley-min="1" min="1" Value="${ScoutPlanBanner.Goals[ItemID]}">
                                    </label>
                                `));
                            };
                        };
                    };
                    
                    if (ExpiredActiveItems.length > 0) {
                        let RemovedRows = `Expired wish plan row(s) were detected in the import. The following row(s) have been automatically removed:
                        `
                        for (let i = 0; i < ExpiredActiveItems.length; i++) {
                            RemovedRows += `
                                \u2022 ${ItemsInfo[ExpiredActiveItems[i]].Name}`
                        };
                        RemovedRows += `

                        All other information has been successfully imported.`

                        swal({icon: 'info', text: RemovedRows});
                    };

                    $('input, select').change().trigger('input');

                    if (RunCalcs == true) {
                        $('#Calculate').trigger('click');
                    }
                    else if (Scroll == true) {
                        $('html, body').animate({
                            scrollTop: $("#CalculatorHeaderAnchor").offset().top,
                            easing: 'linear'
                        }, 500);
                    };
                };
            };

            function Export() {
                if (getInvalidFields().length != 0) {
                    swal({icon: 'error', text: 'Invalid information detected. Cannot generate export.'});
                }
                else {
                    let ExportState = JSON.stringify(CompileForm());
                    var temp = $("<input>");
                    $("body").append(temp);
                    temp.val(ExportState).select();
                    document.execCommand("copy");
                    temp.remove();

                    swal({icon: 'success', text: 'Export copied to clipboard.', timer: 2000});
                };
            };

            $(function () {
                $('a[data-toggle="tooltip"]').each(function() {
                    $(this).tooltip({
                        html: true
                    });
                });
            });

            function SetParsleyValidations() {
                $('input:not([type="checkbox"])').on('input', function(){
                    if (!$(this).parsley().isValid()) {
                        $(this).css('background-color', '#E55451');
                    }
                    else{
                        $(this).css('background-color', 'white');
                    };
                });

                $('input:not([type="checkbox"]), select').each(function() {
                    $(this).parsley().validate();
                });
            };

            $(function() {
                // For some reason this is the only way I've been able to get the select2 to automatically resize on window resizing.
                let ResizeTimeout;
                $(window).on('resize', function() {
                    clearTimeout(ResizeTimeout);

                    ResizeTimeout = setTimeout(function() {
                        $('.ScoutPlanItems').select2("destroy").select2(Select2Config);
                    }, 200);
                });

                SetParsleyValidations();

                $('input, select').change().trigger('input');

                let Unsaved = false;
                
                $("input, select").on('change', function() {
                    Unsaved = true;
                });

                window.onbeforeunload = function() {
                    if (Unsaved && !$('#DisableUnsavedChangesWarning').is(':checked')) {
                        return "You have unsaved changes on this page. If you wish to save your changes, then please export them before leaving this page.";
                    };
                };
            });
        </script>
    </body>
</html>